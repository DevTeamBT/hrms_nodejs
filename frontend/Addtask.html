<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous" />
  <!-- <link rel="stylesheet" href="./Addtask.css" /> -->
  <title>New Task</title>
  <link rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/css/bootstrap-select.css" />
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.13.1/js/bootstrap-select.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="./style.css">
</head>

<body>
  <div class="login" style="display: flex; justify-content: space-between; align-items: center; position: absolute; top: 10px; right: 10px;">
    <h5 id="fullNameDisplay">fullName</h5>
    <button type="button" id="logoutButton" class="btn btn-dark">Log Out</button>
</div>


<!-- =============== Navigation ================ -->
<div class="container">
    <div class="navigation">
      <ul>
        <li>
            <a href="#">
                <span class="title">Employee - login</span>
            </a>
        </li>
        <li>
            <a href="./index" class="nav-link px-1 align-middle text-blue">
                <i class="fs-2 bi bi-house-door"></i> <span class="fs-5 ms-4 d-none d-sm-inline pt-2">Home</span></a>
        </li><li>
            <a href="./mydetails" class="nav-link px-1 align-middle text-blue">
                <i class="fs-2 bi bi-file-earmark-person"></i> <span class="fs-5 ms-4 d-none d-sm-inline pt-2">My Details</span></a>
        </li>
        <li>
            <a href="./timesheet" class="nav-link px-1 align-middle text-blue">
                <i class="fs-2 bi bi-clock-history"></i> <span class="fs-5 ms-4 d-none d-sm-inline pt-2">Timesheet</span></a>
        </li>
        <li>
            <a href="./resources" class="nav-link px-1 align-middle text-blue">
                <i class="fs-2 bi bi-gear-wide-connected"></i> <span class="fs-5 ms-4 d-none d-sm-inline pt-2">Resources</span></a>
        </li>
        <li>
            <a href="#" class="nav-link px-1 align-middle text-blue">
                <i class="fs-2 bi bi-chat-left-text"></i> <span class="fs-5 ms-4 d-none d-sm-inline pt-2">Forums</span></a>
        </li>
        <li>
            <a href="./organization" class="nav-link px-1 align-middle text-blue">
                <i class="fs-2 bi bi-diagram-3"></i> <span class="fs-5 ms-4 d-none d-sm-inline pt-2">Organization</span></a>
        </li>

       
    </ul>
    
    </div>
    <div class="toggle" onclick="toggleNav()">
      <ion-icon name="menu-outline"></ion-icon>
  </div>

    <div class="main">
            <div class="topbar">
                
              </div>
        <div class="container mx-5 px-5">
                 <h4 class="mb-3 timesheet">Add Task</h4>
                   <div>
           <div role="alert">
                  <!-- <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button> -->
                </div>

        </div>
    <div class="form">
      <form action="/add/task" id="addTaskForm" method="post">
       
        <div class="mb-3 row">
          <label for="tasktitle" class="col-sm-4 col-form-label"
            >Task Title:</label
          >
          <div class="col-sm-4">
            <input
              type="text"
              class="form-control"
              placeholder="TASK TITLE"
              name="task"
              required
            />
          </div>
        </div>
        <div class="mb-3  row">
          <label for="addteam" class="col-sm-4 col-form-label">Add Team:</label>
          <div class="col-sm-4" >
             <select class="form-control" id="addTeam" name="addTeam[]" multiple required>Select Team
              </select>
          </div>
        </div>

        <div class="mb-3 row">
          <label for="description" class="col-sm-4 col-form-label"
            >Description:</label
          >
          <div class="col-sm-4">
            <input
              type="text"
              class="form-control"
              placeholder="DESCRIPTION"
              name="description"
              required
            />
          </div>
        </div>
        
        <div>
          <div class="buttons">
            <button id="submitButton" type="submit" class="btn btn-primary col-sm-2 mt-5">
              Submit
            </button>
            <button type="button" class="btn btn-secondary col-sm-2 mt-5">
              Cancel
            </button>
          </div>
        </div>
      </form>
    </div>
  <!-- </div> -->
  </div>
  <script>
    var sidebarOpen = true;
    function toggleNav() {
      var sidebar = document.querySelector(".flex-column");
      if (sidebarOpen) {
        sidebar.style.width = "0";
        sidebar.style.padding = "0";
        
      } else {
        sidebar.style.width = "15%";
        sidebar.style.padding = "30px";
        
      }
      sidebarOpen = !sidebarOpen;
    }
    //   function logout() {
    //     var lg=document.querySelector(".btn");
    //     if(lg.)
    //   }
    document.getElementById('logoutButton').addEventListener('click', function () {
      logout();
    });

    function logout() {
      sessionStorage.clear();
      window.history.replaceState({}, 'login', './login');
      window.location.href = './login';
    }
  </script>

  <script>
    document.getElementById('addTaskForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const form = document.querySelector('form'); // Get the form element

      const taskTitle = form.elements['task'].value;
      const description = form.elements['description'].value;
      const selectedTeams = form.elements['addTeam[]'].selectedOptions;

      // Extract the values of the selected options
      const addTeam = Array.from(selectedTeams).map(option => option.value);
      const data = {
        taskTitle: taskTitle,
        description: description,
        addTeam: addTeam,
      };

      try {
        const response = fetch('http://localhost:4000/add/tasks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(data),
        }).then(e => {
          // return JSON.parse(e);
          console.log(e.ok);
          if (e.ok) {
            const result = e.json();
            console.log('Task created:', result);
            alert('Task created successfully!');
            // Redirect to another page after successful task creation
            window.location.href = 'http://localhost:4000/tasks'; // Change '/another-page.html' to the desired page URL
          } else {
            console.error('Error creating task:',e.status, e.statusText);
          }
        });
        // console.log('Response:', response);
        // console.log('Data:', data);
        // 
      } catch (error) {
        console.error('Error creating task:', error);
      }
    });
    // async function createTask(event) {
    //   event.preventDefault();
    //   console.log(event);
    //   // const form = document.querySelector('form'); // Get the form element

    //   // const taskTitle = form.elements['task'].value;
    //   // const description = form.elements['description'].value;
    //   // const selectedTeams = form.elements['addTeam[]'].selectedOptions;

    //   // console.log(selectedTeams);

    //   // Extract the values of the selected options
    //   // const addTeam = Array.from(selectedTeams).map(option => option.value);

    //   // const data = {
    //   //   taskTitle: taskTitle,
    //   //   description: description,
    //   //   addTeam: addTeam,
    //   // };
    //   // console.log('Data:', data);

    //   // try {
    //   //   const response = await fetch('http://localhost:4000/add/tasks', {
    //   //     method: 'POST',
    //   //     headers: {
    //   //       'Content-Type': 'application/json',
    //   //     },
    //   //     body: JSON.stringify(data),
    //   //   });
    //   //   console.log('Response:', response);
    //   //   console.log('Data:', data);
    //   //   if (response.ok) {
    //   //     const result = await response.json();
    //   //     console.log('Task created:', result);
    //   //     alert('Task created successfully!');
    //   //     // Redirect to another page after successful task creation
    //   //     window.location.href = 'http://localhost:4000/tasks'; // Change '/another-page.html' to the desired page URL
    //   //   } else {
    //   //     console.error('Error creating task:', response.status, response.statusText);
    //   //   }
    //   // } catch (error) {
    //   //   console.error('Error creating task:', error);
    //   // }
    // }

  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Retrieve full name from the session and display it
      const fullName = localStorage.getItem('fullName');
      if (fullName) {
        document.getElementById('full-name').innerText = fullName;
      }
    });
  </script>
  

  <!-- ====== ionicons ======= -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  
  <script>
   loggedInUserJSON = localStorage.getItem('loggedInUser');
  
  // Parse the JSON string to get the object
   loggedInUser = JSON.parse(loggedInUserJSON);
  
  // Check if loggedInUser and fullName are present
  if (loggedInUser && loggedInUser.fullName) {
      // If present, update the HTML element with the full name
      document.getElementById('fullNameDisplay').textContent = loggedInUser.fullName;
  } else {
      // If not present, display a default message or handle accordingly
      document.getElementById('fullNameDisplay').textContent = 'Full name not found in localStorage';
  }
  </script>
  <script>
    // Fetch teams from MongoDB
    fetch('http://localhost:4000/users')
      .then(response => response.json())
      .then(data => {
        const selectElement = document.getElementById('addTeam');
        data.forEach(team => {
          const option = document.createElement('option');
          option.value = team._id;
          option.textContent = team.fullName;
          selectElement.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error fetching teams:', error);
      });
  </script>
  <script>
        const loggedInUserJSON = localStorage.getItem('loggedInUser');
  
      // Parse the JSON string to get the object
      const loggedInUser = JSON.parse(loggedInUserJSON);
  
      // Check if loggedInUser and fullName are present
      if (loggedInUser && loggedInUser.fullName) {
          // If present, update the HTML element with the full name
          document.getElementById('fullNameDisplay').textContent = loggedInUser.fullName;
      } else {
          // If not present, display a default message or handle accordingly
          document.getElementById('fullNameDisplay').textContent = 'Full name not found in localStorage';
      }
  </script>
  <script>
    async function createTask(event) {
    event.preventDefault();
    const form = document.querySelector('form'); // Get the form element
  
    const taskTitle = form.elements['task'].value;
    const description = form.elements['description'].value;
    const selectedTeams = form.elements['addTeam[]'].selectedOptions;1
  
    // Extract the values of the selected options
    const addTeam = Array.from(selectedTeams).map(option => option.value);
  
    const data = {
      taskTitle: taskTitle,
      description: description,
      addTeam: addTeam,
    };
    console.log('Data:', data);
  
    try {
      const response = await fetch('http://localhost:4000/add/tasks', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });
      console.log('Response:', response);
      console.log('Data:', data);
      if (response.ok) {
        const result = await response.json();
        //var userName = result.user.taskTitle;
              console.log('Task created:', result);
              if (result && result.task && result.task.taskTitle) {
              localStorage.setItem('taskTitle', result.task.taskTitle);
              localStorage.setItem('description', result.task.description);
              // localStorage.setItem('time', result.task.createdAt);
              console.log(result.task.taskTitle);
            } else {
              console.error('Task title is missing in the response:', result);
            }
        alert('Task created successfully!');
        // Redirect to another page after successful task creation
        window.location.href = 'http://localhost:4000/tasks'; // Change '/another-page.html' to the desired page URL
      } else {
        console.error('Error creating task:', response.status, response.statusText);
      }
    } catch (error) {
      console.error('Error creating task:', error);
    }
    
  }
  </script>
  <!-- <script src="assets/js/main.js"></script> -->
  </body>
  
  </html>




